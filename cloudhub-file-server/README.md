# cloudhub-file-server

文件服务器的部分工作流程说明。

支持存储、读取、删除文件，不支持对文件进行追加（Append）、修改等操作，
即文件上传后为只读状态。

## 文件存储

客户端上传文件后，分块发送到此文件服务器上，一般有多个块。

在接收到多个块之后，按照某种逻辑（依照文件哈希建立文件等）创建或者找到现存的一个容器文件进行写入。

一个容器文件应当由元数据和实际数据两部分组成。（分开成两个文件）

### 元数据文件

对于元数据文件来说，应当包含以下数据：

- 文件块大小
- 文件标识符（ID，可以取哈希值）
- 每个文件的起始块位置和终止块位置
- 该文件终止块的实际字节数

### 实际数据文件

对于实际数据文件来说，其格式应当与下类似：

假设块长64k。块长可以取64k或128k（4kb的倍数）。

> Linux ext3/4文件系统寻址的基本单位为4k，取倍数大概可以加快寻址速度。

结构：

```text
|-------(块数据)-------|--------(块数据)--------|
```

数据块位置：

```text
|----------0----------|-----------1-----------|
```

数据：

```text
|122311...............|.....100000000000000000|
----------------------------| 实际数据分块后一般不足以填充完整个块，后补字节0
```

这里假设最后一个块，即1号块中实际存储的字节数为2k。

则元数据文件中应当记录下以下信息：

- 块长64k
- 该文件标识符
- 该文件起始块为0，终止块为1
- 最后一个块的实际字节长度为2k

读取文件时，从起始块0号开始读取，应读取的字节数为64k + 2k。

## 文件删除

对文件删除时，找到文件所存储的容器，将占用块标记为空闲块。
后续写入时直接写入在空闲块上。

### 空闲块分配

空闲块分配以尽量减少空闲块碎片为目标。

## 文件多副本及同步

在文件服务器接收到文件并存储后，便可开始多副本和同步过程。

两种过程可分为以下两种方法：

- 增量同步：仅对变化块或变化容器发起同步；
- 全量同步：对全部容器都进行同步。

### 多副本/文件服务器发起的文件同步

多副本/文件服务器发起的文件同步过程发生在容器变化时，由元数据服务器分配副本服务器，对副本服务器发起增量同步。

副本服务器接收到请求后，将接收到的数据写入本机服务器中的副本存储区中。写入完成后计算校验码并发送给主机。
主机对校验码进行验证，若不为正确校验码则发起**全量同步**请求，再将容器整体传输给副本服务器直到成功为止。

### 元数据服务器发起的文件同步

> 文件副本传输不存在数据丢失的情况下，文件同步执行频率不需要太高。

元数据服务器定期向文件服务器发起文件同步请求，同时包含副本服务器的主机地址。

之后由持有此文件的主文件服务器向所有的副本服务器发出同步请求。
> 若主文件服务器宕机则查询所有副本服务器，获取校验码并进行比较，若全部错误则视为文件丢失不可复原。

后续流程和文件服务器发起的文件同步基本相同。

不同的是：文件服务器第一次发送的请求包括容器版本号、校验码等信息，
若副本服务器校验后完全相同，则无需继续传输数据。

## 最大限度的可用性

为了提供高可用的文件系统，在写入或启动时初始化容器时发生错误，需要将错误限定在可确定的最小范围。

- 在写入（特指上传）发生错误时，会采取回退（rollback）的方式，清除错误文件并回到写入前的状态。
- 在初始化容器信息时，若部分元数据信息等丢失或遭到修改，则错误范围应缩小到特定容器（或文件）中，
  同时报告元数据服务器并尝试获取副本同步以修复错误。

容器的损坏有以下几种情况：

- 索引文件损坏
- 容器文件损坏
- 容器元数据文件损坏

其中，当仅发生索引文件损坏时，可进行修复。当三种情况同时发生时，为最严重的损坏，将无法定位到具体损坏位置。

容器文件及元数据文件损坏，将定位到包含的具体文件，并标记为损坏。
此时向元数据服务器发送相关损坏信息，以请求修复元数据文件或容器文件。

## 确认元数据服务器状态

在启动后连接到元数据服务器后，元数据服务器返回一个备份节点地址表。
在主（当前连接的）元数据服务器不可用后，自动尝试顺序切换到备份节点元数据服务器上。

