# 元数据服务器

元数据服务器的部分工作流程说明。

## 文件服务器管理
文件服务器管理需要确认文件服务器的活动状态，通过文件服务器向元数据服务器发送心跳实现。
> 一般元数据服务器也是个集群，暂时简化掉。

当元数据服务器在经过2到3个心跳周期未接受到心跳时，视为文件服务器宕机，
将此服务器移除出活动服务器列表。

元数据服务器还需要知晓文件服务器的存储情况。（向文件服务器发起存储请求时实现？）

心跳数据中包含以下信息：
- 服务器地址
- RPC请求端口
- 服务器ID（UUID）

## 文件服务器分配
文件服务器分配包括两方面：
- 一是上传文件时的分配。优先存储到剩余空间较大的文件服务器中，同时需要保证文件不重复存储。
- 二是获取文件时的分配。将客户端的文件请求分散到不同的文件服务器中，利于下载获取时并行传输，提高下载速度。

下面分别介绍两个分配的实现方式。

### 上传文件

通过一致性哈希算法，在根据文件服务器剩余存储空间加权的基础上，
根据请求的文件哈希值分配到文件服务器上。


### 获取文件
读取出文件的主机地址，若配置了文件副本，则一同返回副本服务器地址。
在获取到所有地址后，依据存储的文件长度信息，对所有服务器发起分块下载请求。

## 文件主副本位置
分配文件副本服务器位置的方式与上传文件时分配服务器的方式基本相同。

## 管理文件同步
待续
