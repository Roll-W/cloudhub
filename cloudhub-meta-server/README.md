# cloudhub-meta-server

元数据服务器的部分工作流程说明。

## 文件服务器管理

文件服务器管理需要确认文件服务器的活动状态，通过文件服务器向元数据服务器发送心跳实现。
> 一般元数据服务器也是个集群，暂时简化掉。

当元数据服务器在经过2到3个心跳周期未接受到心跳时，视为文件服务器宕机，
将此服务器移除出活动服务器列表。

元数据服务器还需要知晓文件服务器的存储情况。

心跳数据中包含以下信息：

- 服务器地址
- RPC请求端口
- 服务器ID（UUID）

以及可选的信息（通过元数据服务器的响应告知是否需要）：

- 文件服务器的状态值
- 文件服务器的具体状态
- 文件服务器的错误信息
    - 需要包含受到影响或损坏的文件ID。

## 文件服务器分配

文件服务器分配包括两方面：

- 一是上传文件时的分配。优先存储到剩余空间较大的文件服务器中，同时需要保证文件不重复存储。
- 二是获取文件时的分配。将客户端的文件请求分散到不同的文件服务器中，利于下载获取时并行传输，提高下载速度。

下面分别介绍两个分配的实现方式。

### 上传文件

通过一致性哈希算法，在根据文件服务器剩余存储空间加权的基础上，
根据请求的文件哈希值分配到文件服务器上，具体分配方法请见[文件主副本位置](#文件主副本位置)。
> 未实现部分：
>
> 将文件分块后分别发送到不同服务器上，减轻单个服务器存储压力。

详细上传过程：

1. meta-server首先检查存储信息，如果数据库中存在文件信息
    - 存在信息时，向`master`发送请求，`master`验证本地存在文件后返回文件存在响应。
    - 若`master`宕机，则向`replica`服务器发起请求。`replica`存在文件返回文件存在响应，
      不存在时对所有`replica`依次继续发起请求。
    - 若所有replica均不存在文件，按照上传新文件的流程发起请求。
    - 假设所有服务器全部宕机，则按照上传新文件的流程发送请求
2. meta-server依照文件哈希值分配`master`服务器及`replica`服务器。
3. 向`master`服务器发送确认信息，包含`replica`服务器信息。
4. 传输文件数据
5. 发送过后，`master`检查本地文件信息，发回确认。若检查错误则重新传输文件数据。
6. 校验成功后，meta-server关闭响应。`master`开始发起副本请求。

### 获取文件

读取出文件的主机地址，若配置了文件副本，则一同返回副本服务器地址。

获取方式：

- 在获取到所有地址后，依据存储的文件长度信息，对所有服务器发起分块下载请求。
  > 此方式预留了接口，但目前主要以完整文件的获取为主。
- 对当前IO负载最小的服务器发起完整文件的获取请求。

## 文件主副本位置

分配文件副本服务器位置的方式与上传文件时分配服务器的方式基本相同。
分配副本服务器采用一主二从一共三副本的方式进行分配。主副本即为上传时分配的服务器。

服务器分配使用一致性哈希算法，依照给定的服务器权重创建虚拟哈希节点。
将所有节点映射到一个首位相连的哈希环上。

通过此种方式分配，能够尽量使哈希值相近的集中在几台服务器中，提高块利用率。

## 管理文件同步

文件同步的发起可以有多种方式：

- 文件服务器请求发起（发生在文件服务器块变动时）
- 元数据服务器发起（一般发生在文件服务器数据损坏时）
- 手动发起

## 管理文件状态

元数据服务器还可对文件状态进行追溯管理。

文件在存储过程中会经历以下状态或过程：
- TEMPORARY：处于元文件服务器的暂存区，文件不可用。
- STORING：处于文件服务器存储的过程中,文件不可用。
- SYNCING: 处于文件服务器存储中，副本同步状态，文件当前可用，副本不可用。
- AVAILABLE：文件和副本现在都可用。
- LOST：文件和副本都丢失了。

在上传完成后，服务器保存文件的副本位置用于之后获取时使用。
